{% extends 'base.html' %}
{% load static %}

{% load math_filters %}

{% block title %}Progression - {{ course.title }}{% endblock %}
{% block page_title %}Progression du cours{% endblock %}
{% block page_subtitle %}{{ course.title }}{% endblock %}

{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Progress -->
    <div class="lg:col-span-2">
        <!-- Overall Progress Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Progression Globale</h2>
            
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Complétion</span>
                    <span class="text-2xl font-bold text-blue-500">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="bg-blue-500 h-4 rounded-full transition-all" style="width: {{ enrollment.progress_percentage }}%"></div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Leçons</p>
                    <p class="text-2xl font-bold text-gray-800">{{ completed_lessons }}/{{ total_lessons }}</p>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Temps passé</p>
                    <p class="text-2xl font-bold text-gray-800">{{ total_time|div:3600|floatformat:1 }}h</p>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Score moyen</p>
                    <p class="text-2xl font-bold text-gray-800">{{ average_score|floatformat:0 }}%</p>
                </div>
            </div>
        </div>

        <!-- Modules Progress -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Progression par Module</h2>
            
            <div class="space-y-4">
                {% for module in modules %}
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">{{ module.title }}</h3>
                        <span class="text-sm text-gray-500">{{ module.completed_lessons }}/{{ module.total_lessons }} leçons</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: {{ module.progress_percentage }}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        {% for lesson in module.lessons.all %}
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center">
                                {% if lesson.is_completed %}
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {% else %}
                                <svg class="w-5 h-5 text-gray-300 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {% endif %}
                                <span class="{% if lesson.is_completed %}text-gray-800{% else %}text-gray-500{% endif %}">
                                    {{ lesson.title }}
                                </span>
                            </div>
                            <span class="text-gray-500">{{ lesson.duration }} min</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar Stats -->
    <div class="lg:col-span-1">
        <!-- Quick Stats -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="font-semibold text-gray-800 mb-4">Statistiques</h3>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Dernière activité</span>
                        <span class="font-semibold">{{ enrollment.last_accessed|date:"d/m" }}</span>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Date d'inscription</span>
                        <span class="font-semibold">{{ enrollment.enrolled_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
                
                {% if enrollment.completed_at %}
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Complété le</span>
                        <span class="font-semibold text-green-600">{{ enrollment.completed_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="font-semibold text-gray-800 mb-4">Activité Récente</h3>
            
            <div class="space-y-3">
                {% for activity in recent_activities %}
                <div class="flex items-start">
                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800">{{ activity.lesson.title }}</p>
                        <p class="text-xs text-gray-500">{{ activity.completed_at|timesince }} ago</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 text-center py-4">Aucune activité récente</p>
                {% endfor %}
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="font-semibold text-gray-800 mb-4">Actions</h3>
            
            <div class="space-y-3">
                <a href="{% url 'courses:detail' course.slug %}" 
                   class="block w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-center">
                    Continuer le cours
                </a>
                
                {% if enrollment.is_completed %}
                <a href="{% url 'certificates:detail' course.id %}" 
                   class="block w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition text-center">
                    Voir le certificat
                </a>
                {% endif %}
                
                <button class="block w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    Télécharger le résumé
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}